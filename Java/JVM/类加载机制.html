<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>类加载机制 | HOME</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.b7772529.css" as="style"><link rel="preload" href="/assets/js/app.9d904b3d.js" as="script"><link rel="preload" href="/assets/js/10.9013529b.js" as="script"><link rel="prefetch" href="/assets/js/11.869fab07.js"><link rel="prefetch" href="/assets/js/12.3f5f9871.js"><link rel="prefetch" href="/assets/js/13.6659e7d3.js"><link rel="prefetch" href="/assets/js/14.1d3506d2.js"><link rel="prefetch" href="/assets/js/15.3080db10.js"><link rel="prefetch" href="/assets/js/16.4fc57f88.js"><link rel="prefetch" href="/assets/js/17.da628472.js"><link rel="prefetch" href="/assets/js/18.39e95fc4.js"><link rel="prefetch" href="/assets/js/19.b288d28b.js"><link rel="prefetch" href="/assets/js/2.921b713c.js"><link rel="prefetch" href="/assets/js/20.41d0b1d4.js"><link rel="prefetch" href="/assets/js/21.e07d8119.js"><link rel="prefetch" href="/assets/js/22.fbdb04d1.js"><link rel="prefetch" href="/assets/js/23.11e9b6d7.js"><link rel="prefetch" href="/assets/js/24.195712b2.js"><link rel="prefetch" href="/assets/js/25.4cbdb8d4.js"><link rel="prefetch" href="/assets/js/26.e23dc3b4.js"><link rel="prefetch" href="/assets/js/27.0d8a5a1b.js"><link rel="prefetch" href="/assets/js/28.52693a31.js"><link rel="prefetch" href="/assets/js/29.9011c4b0.js"><link rel="prefetch" href="/assets/js/3.e3aace97.js"><link rel="prefetch" href="/assets/js/30.f56da937.js"><link rel="prefetch" href="/assets/js/31.3cccece4.js"><link rel="prefetch" href="/assets/js/32.57d6a71d.js"><link rel="prefetch" href="/assets/js/33.1221069e.js"><link rel="prefetch" href="/assets/js/34.da1f1c37.js"><link rel="prefetch" href="/assets/js/35.dbb58bf8.js"><link rel="prefetch" href="/assets/js/36.a5ab3b08.js"><link rel="prefetch" href="/assets/js/37.6416dd30.js"><link rel="prefetch" href="/assets/js/38.4983b3e1.js"><link rel="prefetch" href="/assets/js/39.13a3b5bd.js"><link rel="prefetch" href="/assets/js/4.4eb6808f.js"><link rel="prefetch" href="/assets/js/40.b680f394.js"><link rel="prefetch" href="/assets/js/41.49f96a1c.js"><link rel="prefetch" href="/assets/js/42.c92c60eb.js"><link rel="prefetch" href="/assets/js/43.a425f3b7.js"><link rel="prefetch" href="/assets/js/44.096a4db6.js"><link rel="prefetch" href="/assets/js/45.b06e8bd6.js"><link rel="prefetch" href="/assets/js/46.844e3c11.js"><link rel="prefetch" href="/assets/js/47.f4c02112.js"><link rel="prefetch" href="/assets/js/5.6fc37189.js"><link rel="prefetch" href="/assets/js/6.9e5db50c.js"><link rel="prefetch" href="/assets/js/7.015c0e7f.js"><link rel="prefetch" href="/assets/js/8.05b4ddad.js"><link rel="prefetch" href="/assets/js/9.43b0d755.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b7772529.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="HOME" class="logo"> <span class="site-name can-hide">HOME</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/vay-qz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/vay-qz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="类加载机制"><a href="#类加载机制" aria-hidden="true" class="header-anchor">#</a> 类加载机制</h1> <p></p><div class="table-of-contents"><ul><li><a href="#加载过程">加载过程</a><ul><li><a href="#加载">加载</a></li><li><a href="#验证">验证</a></li><li><a href="#准备">准备</a></li><li><a href="#解析">解析</a></li><li><a href="#初始化">初始化</a></li></ul></li><li><a href="#类加载器">类加载器</a><ul><li><a href="#双亲委派模型-parents-delegation-model">双亲委派模型(Parents-Delegation-Model)</a><ul><li><a href="#概念">概念</a></li></ul></li></ul></li></ul></div><p></p> <p>一个类时如何被虚拟机加载运行？究竟经历了哪些步骤呢？本文就Java中类的加载机制进行详细的讲解。</p> <h2 id="加载过程"><a href="#加载过程" aria-hidden="true" class="header-anchor">#</a> 加载过程</h2> <p>一个类从被虚拟机加载直到被虚拟机卸载的过程程为类的生命周期，可分为以下7个步骤</p> <p><img src="/assets/img/jz.0b164e02.png" alt></p> <p>每个类都会经历以上7个步骤，其中加载、验证、准备、初始化、卸载这五个步骤将按部就班的<strong>开始</strong>，而解析则不一定，解析可能会在初始化之后才开始进行</p> <h3 id="加载"><a href="#加载" aria-hidden="true" class="header-anchor">#</a> 加载</h3> <p>加载阶段的工作，根据类的全限定名获取类的二进制流</p> <ol><li>类加载器根据类的全限定名获取类的二进制流</li> <li>根据二进制流所代表的数据结构在方法区生成对应的数据结构</li> <li>根据数据结构在方法区生成java.lang.Class对象作为该类的入口</li></ol> <p>类的加载阶段是程序员们可操作性最大的阶段、我们可以使用虚拟机自带的类加载器，也可以自定义类加载器</p> <h3 id="验证"><a href="#验证" aria-hidden="true" class="header-anchor">#</a> 验证</h3> <p>由于二进制流的获取途径后很多，可以通过Java文件、网络、直接使用二进制编辑器编写、数据库、JSP，所以就需要对加载进来的class进行验证，主要验证一下4个方面</p> <ol><li>文件格式验证</li> <li>元数据验证（Java语法验证）</li> <li>字节码验证（自卫验证，防止有对虚拟机有害的代码）</li> <li>符号引用验证（是否每个符号引用都可以找到对应的类）</li></ol> <p>验证阶段和加载阶段有一部分时交叉进行的，而且如果验证程序是没有问题的话在实施阶段可以通过*-Xverify:none*来关闭</p> <h3 id="准备"><a href="#准备" aria-hidden="true" class="header-anchor">#</a> 准备</h3> <p>再通过验证之后，虚拟机就要对所有的<strong>类成员变量</strong>进行内存分配，此时并不对实例对象进行内存分配。这个时候的类成员变量还是其零值，类成员变量的零值如下表</p> <table><thead><tr><th>char</th> <th>'\u0000`</th> <th>int</th> <th>0</th></tr></thead> <tbody><tr><td>long</td> <td>0.0f</td> <td>short</td> <td>(short)0</td></tr> <tr><td>boolean</td> <td>false</td> <td>reference</td> <td>null</td></tr> <tr><td>float</td> <td>0</td> <td>double</td> <td>0.0d</td></tr> <tr><td>byte</td> <td>(byte)0</td> <td></td> <td></td></tr></tbody></table> <p>但是对于已经被final修饰过的类成员变量，在准备阶段就已经赋为了实际值</p> <h3 id="解析"><a href="#解析" aria-hidden="true" class="header-anchor">#</a> 解析</h3> <p>解析阶段的工作就是将符号引用转化为直接引用</p> <blockquote><p><strong>符号引用</strong>：以一些符号来对类进行描述，也可以是任意的形式，只要在引用的时候可以无歧义的找到类即可</p> <p><strong>直接引用</strong>：可以是直接指向类的指针、偏移量或者是间接指向类的符号</p></blockquote> <p>每个类可能被多次解析，解析结果在虚拟机中有缓存保留，第一次解析成功后，接下来的解析也应保证其解析成功</p> <h3 id="初始化"><a href="#初始化" aria-hidden="true" class="header-anchor">#</a> 初始化</h3> <p>在初始化阶段，虚拟机为每一个类收集并生成&lt;clint&gt;方法，&lt;clint&gt;方法由<strong>static静态代码块</strong>和<strong>静态赋值语句</strong>生成，如果一个类中没有上述代码则不生成&lt;clint&gt;方法。其收集顺序取决于在代码中的顺序，static静态代码块可以修改在其之后的静态变量，但是却不能访问。每个类的&lt;clint&gt;方法执行之前其父类一定已经初始化，接口则不需要。虚拟机可以保证&lt;clint&gt;方法的线程安全，所以单例模式的饿汉式是线程安全的</p> <p>当且仅当类在以下五种情况下会进行初始化</p> <ol><li>当遇到new、putstatic、getstatic、invoke指令时</li> <li>main方法所在类</li> <li>当一个类被初始化时，其父类一定已经完成了初始化，所以第一个初始化的类一定是Object</li> <li>当使用java.lang.invoke时</li> <li>当使用java.util.methodHandle时</li></ol> <p>以上五种情况称为对类的主动引用，当然还有几种对类的被动引用</p> <ul><li>通过子类来引用父类中的final类变量</li> <li>数组</li> <li>引用一个类中的final型的类变量</li></ul> <h2 id="类加载器"><a href="#类加载器" aria-hidden="true" class="header-anchor">#</a> 类加载器</h2> <p>如上文提到，在加载阶段，虚拟机根据<strong>类的全限定类名</strong>来获取类的二进制流，而这一步是放在虚拟机之外进行的。对于虚拟机而言，类加载器分为两类，初始化加载器和其他，但是其实根据其加载职责的不同还可以再进行细分</p> <ul><li>启动类加载器：加载&lt;JAVA_HOME&gt;\lib文件夹下的类</li> <li>扩展类加载器：加载&lt;JAVA_HOME&gt;\lib\ext下的类</li> <li>系统类加载器</li> <li>自定义加载器</li></ul> <p>为什么要对加载器进行这样的划分呢？因为类的唯一性是由类及其加载器来判断的，如果两个相同的对象使用不同的加载器进行加载，那么其一定是不等的，例如Class#isInstance，Class#equals，instanceof关键字</p> <h3 id="双亲委派模型-parents-delegation-model"><a href="#双亲委派模型-parents-delegation-model" aria-hidden="true" class="header-anchor">#</a> 双亲委派模型(Parents-Delegation-Model)</h3> <p>Java团队对于自定义的类加载器提供了这么一种加载机制——parents delegation model，也由于译者的原因，翻译成中文之后就变成了双亲委派模型，笔者在首次读到的时候就有一个疑惑，为什么是双亲而不是单亲呢？双亲指的是哪两个呢？其实都不是的！应该的翻译为父类委派模型，每个类其实只要一个父类，其关系如下图</p> <p><img src="/assets/img/parents.cb1c6911.png" alt></p> <h4 id="概念"><a href="#概念" aria-hidden="true" class="header-anchor">#</a> 概念</h4> <p>类加载器加载类时应首先交给其父类进行加载，如果父类无法加载，则由自己进行加载。值得注意的是，由系统提供的这三个加载器并不是继承的关系，而是组合关系。</p> <p>如果我们想自定义一个加载器，应该怎么做呢？</p> <ol><li>继承ClassLoader类</li> <li>不破坏双亲委派模型则重写findClass类，破坏则重写loadClass类</li></ol> <blockquote><p>文末链接为一个自定义获取磁盘上任意class文件的一个小例子</p></blockquote> <p>双亲委派模型在Java的发展历程中经历过三次大规模的”被破坏“</p> <ol><li>双亲委派模型是在jdk1.2版本提出的，而在Java1.0~Java1.2之间一直都是被破坏状态</li> <li>双亲委派模型解决了类优先级的问题，但是也会导致顶层的类加载器无法加载较高层的代码，所以为了解决这一问题，引入了一个线程上下文加载器，默认继承创建线程的类的加载器</li> <li>热部署OSGi</li></ol></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.9d904b3d.js" defer></script><script src="/assets/js/10.9013529b.js" defer></script>
  </body>
</html>
