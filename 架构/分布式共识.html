<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简介 | HOME</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.b7772529.css" as="style"><link rel="preload" href="/assets/js/app.9d904b3d.js" as="script"><link rel="preload" href="/assets/js/23.11e9b6d7.js" as="script"><link rel="prefetch" href="/assets/js/10.9013529b.js"><link rel="prefetch" href="/assets/js/11.869fab07.js"><link rel="prefetch" href="/assets/js/12.3f5f9871.js"><link rel="prefetch" href="/assets/js/13.6659e7d3.js"><link rel="prefetch" href="/assets/js/14.1d3506d2.js"><link rel="prefetch" href="/assets/js/15.3080db10.js"><link rel="prefetch" href="/assets/js/16.4fc57f88.js"><link rel="prefetch" href="/assets/js/17.da628472.js"><link rel="prefetch" href="/assets/js/18.39e95fc4.js"><link rel="prefetch" href="/assets/js/19.b288d28b.js"><link rel="prefetch" href="/assets/js/2.921b713c.js"><link rel="prefetch" href="/assets/js/20.41d0b1d4.js"><link rel="prefetch" href="/assets/js/21.e07d8119.js"><link rel="prefetch" href="/assets/js/22.fbdb04d1.js"><link rel="prefetch" href="/assets/js/24.195712b2.js"><link rel="prefetch" href="/assets/js/25.4cbdb8d4.js"><link rel="prefetch" href="/assets/js/26.e23dc3b4.js"><link rel="prefetch" href="/assets/js/27.0d8a5a1b.js"><link rel="prefetch" href="/assets/js/28.52693a31.js"><link rel="prefetch" href="/assets/js/29.9011c4b0.js"><link rel="prefetch" href="/assets/js/3.e3aace97.js"><link rel="prefetch" href="/assets/js/30.f56da937.js"><link rel="prefetch" href="/assets/js/31.3cccece4.js"><link rel="prefetch" href="/assets/js/32.57d6a71d.js"><link rel="prefetch" href="/assets/js/33.1221069e.js"><link rel="prefetch" href="/assets/js/34.da1f1c37.js"><link rel="prefetch" href="/assets/js/35.dbb58bf8.js"><link rel="prefetch" href="/assets/js/36.a5ab3b08.js"><link rel="prefetch" href="/assets/js/37.6416dd30.js"><link rel="prefetch" href="/assets/js/38.4983b3e1.js"><link rel="prefetch" href="/assets/js/39.13a3b5bd.js"><link rel="prefetch" href="/assets/js/4.4eb6808f.js"><link rel="prefetch" href="/assets/js/40.b680f394.js"><link rel="prefetch" href="/assets/js/41.49f96a1c.js"><link rel="prefetch" href="/assets/js/42.c92c60eb.js"><link rel="prefetch" href="/assets/js/43.a425f3b7.js"><link rel="prefetch" href="/assets/js/44.096a4db6.js"><link rel="prefetch" href="/assets/js/45.b06e8bd6.js"><link rel="prefetch" href="/assets/js/46.844e3c11.js"><link rel="prefetch" href="/assets/js/47.f4c02112.js"><link rel="prefetch" href="/assets/js/5.6fc37189.js"><link rel="prefetch" href="/assets/js/6.9e5db50c.js"><link rel="prefetch" href="/assets/js/7.015c0e7f.js"><link rel="prefetch" href="/assets/js/8.05b4ddad.js"><link rel="prefetch" href="/assets/js/9.43b0d755.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b7772529.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="HOME" class="logo"> <span class="site-name can-hide">HOME</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/vay-qz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/vay-qz" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h2 id="简介"><a href="#简介" aria-hidden="true" class="header-anchor">#</a> 简介</h2> <p><img src="/assets/img/in.e1559e70.jpg" alt></p> <p>paxio协议更加偏向于分布式共识思想，而不是一种具体实现算法
Gossip、zab、raft则是实际实现的，细节会更加丰富
从是否有leader可以分为单主与无主</p> <h2 id="basic-paxio"><a href="#basic-paxio" aria-hidden="true" class="header-anchor">#</a> Basic-paxio</h2> <p><strong>聚焦点：如何达成共识</strong>
在paxio协议中，每个节点都有提案权、投票权，当需要对一个事务形成共识时，要经历两阶段过程
<strong>一阶段：提案阶段（prepare）</strong></p> <ol><li>提案节点向其余节点发送提案信息（id，i，1），代表当前的提案id和希望设置i=1的共识</li> <li>其余节点在收到消息后，会做出两个承诺和一个回应</li></ol> <blockquote><p>承诺：</p> <ol><li>承诺不再回应小于或等于提案id的提案（prepare）</li> <li>承诺不接受小于提案id的提案（accept）</li></ol></blockquote> <p>回应：</p> <blockquote><p>在自己的已提交提案中，找到最大的提案id对应的值并返回，若没有相应提案，则返回null</p></blockquote> <ol start="3"><li>提案节点在收到过半数量的回应后，进入下一阶段</li></ol> <p><strong>二阶段：确认阶段（accept）</strong></p> <ol><li>提案节点向其余节点发出确认消息</li> <li>其余节点根据自己的消息情况选择回应或不处理，回应规则为一阶段步骤2中的承诺2。</li> <li>提案节点在收到超过半数的消息后，提交该提案并通知其余节点</li> <li>其余节点收到通知消息后提交自己的提案</li></ol> <p><strong>paxio的两个问题</strong> <strong>一、活锁问题</strong>
在一阶段结束后，假设其他节点又收到了（x+1，i， 2）的prepare信息，此时其他节点</p> <ol><li>不再回应小于或等于x+1的提案</li> <li>不再接受小于x+1的确认</li></ol> <p>而后再收到最初的提案节点的确认请求（x，i，1），由于x &lt; x+1，故不再被其余节点接受，以上情况在极端情况下可能会一直循环发生，形成活锁。
<strong>二、性能问题</strong>
对于每个提案的成功接收，需要两阶段过程，即两阶段IO</p> <h2 id="multi-paxio"><a href="#multi-paxio" aria-hidden="true" class="header-anchor">#</a> Multi-paxio</h2> <p>为了解决以上问题，Multi-paxio诞生了，Multi-paxio通过选主来解决io和活锁的问题。
<strong>角色：提案节点、决策节点、学习节点</strong> <strong>如何选主？</strong>
Multi-paxio的选主过程为Basic-paxio，这里不再赘述。在选出leader节点后，其余节点为follower，主从之间通过心跳来进行判活。
<strong>如何复制数据？</strong>
在Multi-paxio中，每次提案都由leader来完成，leader收到客户端请求后</p> <ol><li>提案节点发送信息（1，id，i，1）给决策节点，表示当前任期是1，提案id为id，希望设置i=1</li> <li>决策节点在收到信息后，判断与当前任期的情况，若任期相同，则返回同意，否则说明当前落后，与leader进行数据同步</li> <li>提案节点在收到过半的票数后提交提案，广播给其余决策节点</li> <li>其余决策节点在收到广播后提交提案</li></ol> <p><strong>网络分区情况</strong>
假设现在有一个有s1,s2,s3,s4,s5组成的集群，当前s1为leader，此时网络分为了两部分，s1+s2和s3+s4+s5，此时s3这个集群发现无法与s1进行通信后，开始投票选举新的leader。假设选为了s3，此时s3继续正常进行工作。此时s1集群由于不满足大多数，无法在提交提案。当网络分区恢复后，s1，s2回滚自己未提交的提案，与s3同步数据
<strong>Multi-paxio能保证提案的顺序吗？</strong>
不能</p> <h2 id="zab"><a href="#zab" aria-hidden="true" class="header-anchor">#</a> Zab</h2> <p>专门为zookeeper设计的协议。在zab协议中，每个节点有4中状态</p> <blockquote><p><strong>looking：寻找主节点状态</strong> <strong>follow：跟随着</strong> <strong>leader：领导者</strong> <strong>observer：观察者</strong></p></blockquote> <p><strong>故障恢复阶段</strong></p> <ol><li>leader故障，follower在一段时间没有收到心跳后，将本身状态设为looking，并开始进行投票选举，将自身的任期+1而后发送（zxid，sid）给其他集群中的follower节点</li></ol> <blockquote><p>zxid为long类型，高32位表示任期，低32位表示提案id，任期和提案id都是单调递增的
sid为一个类似myid的唯一标识</p></blockquote> <ol start="2"><li>其他follower收到提议后，将自身状态设为looking，若已经是looking，则开始进行领导者pk。pk依据为：任期 &gt; 提案id &gt; sid，最终投出自己的票</li> <li>每个looking节点根据自己的票选情况，来判断自身状态，若当选，则将自身状态改为leader，否则改为follow，并广播给其余follower</li> <li>所有follower与新leader进行数据同步，follower将自身的最大事务id：fid发送给leader。leader会为每个follower开辟事务提交队列。当前队列最小的事务id：minid，当前队列最大的事务id：maxid
<ol><li>当minid &lt; fid &lt; maxId时
<ol><li>若fid在队列中能找到对应项，则说明follower落后leader，同步缺失数据到follower</li> <li>若fid在队列中不能找到对应项，则说明有冲突数据，此时以leader数据为准，follower先回滚再同步</li></ol></li> <li>当fid &lt; minid时，说明follower远远落后leader，同步leader的snapshot</li> <li>当fid &gt; maxid时，说明follower中有多余的提案，此时有两种情况
<ol><li>follower单纯的领先leader，此时回滚到maxid即可</li> <li>follower与leader有冲突节点，此时要先回滚在同步</li></ol></li></ol></li> <li>集群恢复正常，可继续对外提供服务</li></ol> <p><strong>消息广播阶段</strong></p> <ol><li>leader接收到客户端请求，生成事务id，将信息和zxid广播给follower</li> <li>follower收到后，将消息中的任期与本身任期对比
<ol><li>任期一致，<strong>暂存</strong></li> <li>任期 &lt; 本身任期，说明是上一任leader，不予处理</li> <li>任期 &gt; 本身任期，说明自身落后，开始与leader进行数据同步</li></ol></li> <li>leader收到过半ask后，提交本地事务，并广播提交指令给follower</li> <li>follower在收到commit指令后，<strong>将本地暂存的zxid于指令中的zxid作比较</strong>，若一致则提交，不一致则与leader进行数据同步</li></ol> <p>ps:步骤中的加黑字体是从节点保持数据顺序性的关键</p> <h2 id="raft"><a href="#raft" aria-hidden="true" class="header-anchor">#</a> Raft</h2> <p>角色状态：leader、follower、候选人
Raft中的提案叫日志
<strong>如何选主？</strong>
当follower超时未收到leader的消息时</p> <ol><li>follower自己成为候选人，将自己的任期+1，而后向所有人发送要参选的消息。</li> <li>其余follower收到消息后，根据如下规则进行投票，当有并发情况时，遵循先到先得原则
<ol><li>自己的任期 &lt; 消息中的任期</li> <li>自己的最大日志id &lt; 消息中的最大id，即follower不会投票给日志落后于自己的节点</li></ol></li> <li>候选人收到超过半数的票后则当选leader，而后向其余节点广播当选消息</li> <li>其余follower与leader进行数据同步，leader发送自己的最新消息（rq，logId），任期和logid，follower将其与自己的日志进行比较
<ol><li>若未找到，则leader发送再前一个日志节点二元组(rq，logid)</li> <li>若找到，则同步当前日志到最新日志的所有日志给follower</li></ol></li></ol> <p><strong>如何复制数据？</strong></p> <ol><li>leader将日志广播给follower节点</li> <li>follower将日志中的信息与自身信息作比较，若任期和日志id都满足要求，则恢复ack</li> <li>leader收到过半ack后恢复客户端</li></ol> <p>ps:leader不发送确认消息，follower如何提交呢
leader会将自己已提交的日志通过心跳发送给follower，每个follower收到心跳后提交自己的日志</p> <h2 id="gossip"><a href="#gossip" aria-hidden="true" class="header-anchor">#</a> Gossip</h2> <p>多主形式
每个节点都可以发起提案。而后广播给若干个其他节点，这里广播有两种方式
反熵
每次同步时节点之间数据全量同步
传谣
每次同步只发送增量更新数据</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.9d904b3d.js" defer></script><script src="/assets/js/23.11e9b6d7.js" defer></script>
  </body>
</html>
