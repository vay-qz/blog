(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{194:function(t,_,e){t.exports=e.p+"assets/img/lock.5b2ebe53.jpg"},246:function(t,_,e){"use strict";e.r(_);var v=[function(){var t=this.$createElement,_=this._self._c||t;return _("blockquote",[_("p",[this._v("目的：Consistency——一致性\n手段")]),this._v(" "),_("ul",[_("li",[this._v("Atomic——原子性")]),this._v(" "),_("li",[this._v("isolution——隔离性")]),this._v(" "),_("li",[this._v("durability——持久性")])])])},function(){var t=this.$createElement,_=this._self._c||t;return _("blockquote",[_("p",[this._v("持久性：redolog + binlog\n原子性：undolog\n隔离性：mvcc + 锁 + undolog")])])},function(){var t=this.$createElement,_=this._self._c||t;return _("h3",{attrs:{id:"持久性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#持久性","aria-hidden":"true"}},[this._v("#")]),this._v(" 持久性")])},function(){var t=this.$createElement,_=this._self._c||t;return _("table",[_("thead",[_("tr",[_("th",[this._v("server层执行器")]),this._v(" "),_("th",[this._v("innodb引擎层")])])]),this._v(" "),_("tbody",[_("tr",[_("td"),this._v(" "),_("td")])])])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("ol",[e("li",[t._v("查询指定数据\n|  |\n|  |")]),t._v(" "),e("li",[t._v("从buffer pool中查询数据\n|\n|  |   3.1 查到则直接返回数据页\n3.2 查不到则从磁盘中寻找数据页返回 |\n|")]),t._v(" "),e("li",[t._v("更新对应数据\n|  |\n|")]),t._v(" "),e("li",[t._v("将数据写回磁盘\n|  |\n|  |")]),t._v(" "),e("li",[t._v("将数据写到buffer pool\n|\n|  |")]),t._v(" "),e("li",[t._v("记录redolog，标记为prepare状态\n|\n|")]),t._v(" "),e("li",[t._v("记录binlog\n|  |\n|")]),t._v(" "),e("li",[t._v("调用提交接口\n|  |\n|  |")]),t._v(" "),e("li",[t._v("将redolog对应数据标记为commit状态\n|")])])},function(){var t=this.$createElement,_=this._self._c||t;return _("ol",[_("li",[this._v("步骤8之前，数据没有记录在日志文件中")]),this._v(" "),_("li",[this._v("步骤8-9之间，日志记录到了redolog，但没有记录到binlog")]),this._v(" "),_("li",[this._v("步骤9之后，日志记录到了日志文件中")])])},function(){var t=this.$createElement,_=this._self._c||t;return _("h6",{attrs:{id:"checkpoint机制"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#checkpoint机制","aria-hidden":"true"}},[this._v("#")]),this._v(" checkpoint机制")])},function(){var t=this.$createElement,_=this._self._c||t;return _("ol",[_("li",[this._v("redolog是顺序写，而数据文件是随机写，随机写速度慢")]),this._v(" "),_("li",[this._v("redolog并不需要把整个数据页都更新，io少")])])},function(){var t=this.$createElement,_=this._self._c||t;return _("h3",{attrs:{id:"原子性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#原子性","aria-hidden":"true"}},[this._v("#")]),this._v(" 原子性")])},function(){var t=this.$createElement,_=this._self._c||t;return _("h3",{attrs:{id:"隔离性"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#隔离性","aria-hidden":"true"}},[this._v("#")]),this._v(" 隔离性")])},function(){var t=this.$createElement,_=this._self._c||t;return _("h4",{attrs:{id:"mvcc"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#mvcc","aria-hidden":"true"}},[this._v("#")]),this._v(" MVCC")])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("table",[e("thead",[e("tr",[e("th",[t._v("事务1")]),t._v(" "),e("th",[t._v("事务2")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("truncate user;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("start transaction")]),t._v(" "),e("td",[t._v("start transaction")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("insert into user values(1);")])]),t._v(" "),e("tr",[e("td",[t._v("// 一")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("select count(*) from user")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("commit;")])]),t._v(" "),e("tr",[e("td",[t._v("// 二")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("select count(*) from user")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("commit;")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("// 三")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("select count(*) from user")]),t._v(" "),e("td")])])])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("table",[e("thead",[e("tr",[e("th"),t._v(" "),e("th",[t._v("RU")]),t._v(" "),e("th",[t._v("RC")]),t._v(" "),e("th",[t._v("RR")]),t._v(" "),e("th",[t._v("Serial")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("sql一")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("0")]),t._v(" "),e("td",[t._v("0")]),t._v(" "),e("td",[t._v("报错")])]),t._v(" "),e("tr",[e("td",[t._v("sql二")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("0")]),t._v(" "),e("td",[t._v("报错")])]),t._v(" "),e("tr",[e("td",[t._v("sql三")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("1")]),t._v(" "),e("td",[t._v("1")])])])])},function(){var t=this.$createElement,_=this._self._c||t;return _("h6",{attrs:{id:"readview（快照读）机制如下"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#readview（快照读）机制如下","aria-hidden":"true"}},[this._v("#")]),this._v(" ReadView（快照读）机制如下")])},function(){var t=this.$createElement,_=this._self._c||t;return _("h4",{attrs:{id:"lock"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#lock","aria-hidden":"true"}},[this._v("#")]),this._v(" Lock")])},function(){var t=this.$createElement,_=this._self._c||t;return _("p",[_("img",{attrs:{src:e(194),alt:""}})])},function(){var t=this.$createElement,_=this._self._c||t;return _("blockquote",[_("p",[this._v("意向锁：为了简化加表锁的步骤，当需要加表锁时，需要遍历表中每行数据，数据都没锁才能加表锁，效率过慢，当加行锁的时候，首先在表上添加上意向锁\n读锁：共享锁，行锁\n写锁：互斥锁，行锁\n自增锁：主键自增时加的锁\n间隙锁：范围锁，又称GAP，前开后开\n临键锁：范围锁，又称Next-key，前闭后开")])])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("table",[e("thead",[e("tr",[e("th"),t._v(" "),e("th",[t._v("读锁")]),t._v(" "),e("th",[t._v("写锁")]),t._v(" "),e("th",[t._v("意向读锁")]),t._v(" "),e("th",[t._v("意向写锁")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("读锁")]),t._v(" "),e("td",[t._v("√")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("√")]),t._v(" "),e("td",[t._v("X")])]),t._v(" "),e("tr",[e("td",[t._v("写锁")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("X")])]),t._v(" "),e("tr",[e("td",[t._v("意向读锁")]),t._v(" "),e("td",[t._v("√")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("√")]),t._v(" "),e("td",[t._v("√")])]),t._v(" "),e("tr",[e("td",[t._v("意向写锁")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("X")]),t._v(" "),e("td",[t._v("√")]),t._v(" "),e("td",[t._v("√")])])])])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("table",[e("thead",[e("tr",[e("th",[t._v("索引情况")]),t._v(" "),e("th",[t._v("db隔离级别")]),t._v(" "),e("th",[t._v("加锁情况")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("id为主键")]),t._v(" "),e("td",[t._v("RC")]),t._v(" "),e("td")])])])},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("ol",[e("li",[t._v("根据主键索引找到id=13的数据，在该索引上加写锁\n|\n| id为唯一索引 |  |")]),t._v(" "),e("li",[t._v("根据唯一索引找到id=13的数据，在该索引上加写锁")]),t._v(" "),e("li",[t._v("将这一行的主键索引上加写锁\n|\n| id为普通索引 |  |")]),t._v(" "),e("li",[t._v("根据索引找到id=13的所有数据，在该索引上加写锁")]),t._v(" "),e("li",[t._v("在锁住的数据中找到主键列，在主键列的唯一索引上加写锁\n|\n| id不是索引 |  |")]),t._v(" "),e("li",[t._v("对表中的每条数据都加锁\n|\n| id为主键 | RR | 同上 |\n| id为唯一索引 |  | 同上 |\n| id为普通索引 |  |")]),t._v(" "),e("li",[t._v("根据索引找到id=13的所有数据，在该索引上加写锁")]),t._v(" "),e("li",[t._v("在加锁数据的前后间隙，加上GAP锁")]),t._v(" "),e("li",[t._v("在锁住的数据中找到主键列，在主键列的唯一索引上加写锁\n|\n| id不是索引 |  |")]),t._v(" "),e("li",[t._v("对表中的每条数据都加锁")]),t._v(" "),e("li",[t._v("对表中每条数据间隙加上GAP锁\n|")])])},function(){var t=this.$createElement,_=this._self._c||t;return _("h3",{attrs:{id:"参考文档"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#参考文档","aria-hidden":"true"}},[this._v("#")]),this._v(" 参考文档")])}],r=e(0),n=Object(r.a)({},function(){var t=this,_=t.$createElement,e=t._self._c||_;return e("div",{staticClass:"content"},[e("p",[t._v("ACID")]),t._v(" "),t._m(0),t._v(" "),e("p",[t._v("实现")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),e("p",[t._v("一条更新语句的执行步骤")]),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),e("p",[t._v("这里是如何保证crash-safe呢？我们需要关注数据库在以下几个节点发生crash的情况")]),t._v(" "),t._m(5),t._v(" "),e("p",[t._v("情况1，日志文件中根本没有数据，该事务执行rollback\n情况2，只记录到了redolog而没有记录到binlog，执行rollback\n情况3，redolog和binlog都已经记录的该事务，将redolog对应数据标记为commit，继续提交事务\n这里的redolog其实只是更新到了redolog pool内存中，具体何时刷新到redolog_file中，是根据checkpoint机制来的")]),t._v(" "),t._m(6),t._v(" "),e("p",[t._v("既然redolog日志和数据都是先进内存再更新到磁盘，为什么要多这一步呢？redolog的好处在哪？")]),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),e("p",[t._v("一条更新语句会先记录undolog，在对数据进行更新。这样在事务最终进行回滚时，就会根据undolog来进行回滚。")]),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),e("p",[t._v("事务隔离级别\n读未提交——read uncommit（RU）\n读已提交——read commit（RC）\n可重复读——repeat read（RR）\n串行       ——serial")]),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),e("p",[t._v("RU模式能读到未提交的数据，成为脏读\nRC模式下，在同一个事务中，两次读到的结果不一样，称为不可重复读\nRR模式下，事务之内读到的数据和事务之外的数据不一样，称为幻读\n那么模式是如何实现的呢？这里要介绍两个概念\n快照读\nselect * from user\n当前读\nupdate user set id = 2 where id = 1;\ndelete from user where id = 1;\nselect * from user where id = 1 for update;")]),t._v(" "),t._m(13),t._v(" "),e("p",[t._v("在RC模式下，每次读都会创建一个readview\n在RR模式下，每个事务只会创建一个readview\n举例：")]),t._v(" "),t._m(14),t._v(" "),e("p",[t._v("锁的分类")]),t._v(" "),t._m(15),t._v(" "),e("p",[t._v("概念介绍")]),t._v(" "),t._m(16),t._v(" "),e("p",[t._v("读、写、意向锁的互斥关系如下")]),t._v(" "),t._m(17),t._v(" "),e("p",[t._v("update student set age = 10 where id = 13\nage的索引情况和数据库隔离级别，加锁的情况也不同")]),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),e("p",[t._v("复杂语句分析\ntable: user(id, age, userId, comment)\nindex：idx_user_age(age, userId)\ndelete from user where age > 1 and age < 20 and userid = 'hdc' and comment is not null;")]),t._v(" "),e("p",[t._v("​")]),t._v(" "),t._m(20),t._v(" "),e("p",[e("a",{attrs:{href:"https://hoxis.github.io/mysql-zhuanlan-02-redolog-binlog.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://hoxis.github.io/mysql-zhuanlan-02-redolog-binlog.html"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://www.cnblogs.com/wupeixuan/p/11734501.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/wupeixuan/p/11734501.html"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/52977862",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://zhuanlan.zhihu.com/p/52977862"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://km.sankuai.com/page/231603432",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://km.sankuai.com/page/231603432"),e("OutboundLink")],1)])])},v,!1,null,null,null);n.options.__file="事务.md";_.default=n.exports}}]);